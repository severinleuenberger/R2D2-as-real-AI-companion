# Fixes Applied - January 2, 2026

## Summary
Fixed critical bugs preventing VAD timeout and fist gesture detection from working. Fist gesture now successfully stops sessions, but audio beeps not yet working.

---

## Bugs Fixed

### 1. ‚úÖ VAD Publisher Never Instantiated
**Problem:** `ROS2VADPublisher` class existed but was never created in `speech_node.py`
**Impact:** VAD timeout never worked ‚Üí sessions stayed connected forever ‚Üí billing disaster
**Fix:**
- Added `ROS2VADPublisher` to imports
- Created `self.vad_publisher = ROS2VADPublisher(self)` in `on_configure()`
- Passed to `EventRouter(..., vad_publisher=self.vad_publisher)`
**Files:** `ros2_ws/src/r2d2_speech/r2d2_speech_ros/speech_node.py`

### 2. ‚úÖ VAD Timeout Too Long  
**Problem:** 60-second timeout too long for UX
**Fix:** Changed from 60s to 30s in launch file
**Files:** `ros2_ws/src/r2d2_gesture/launch/gesture_intent.launch.py`

### 3. ‚úÖ Gesture Frame Skipping
**Problem:** `gesture_frame_skip=2` caused gestures to be detected sporadically
**Impact:** Fist appeared briefly in monitor then disappeared
**Fix:** Set `gesture_frame_skip=1` in systemd service
**Files:** `/etc/systemd/system/r2d2-camera-perception.service`

### 4. ‚úÖ Gestures Published Only On Change
**Problem:** Perception only published gestures when they CHANGED, not continuously
**Impact:** Rolling window detection couldn't accumulate detections
**Fix:** Modified to publish every frame (with frame_skip), not just on change
**Files:** `ros2_ws/src/r2d2_perception/r2d2_perception/image_listener.py`

### 5. ‚úÖ Fist Threshold Too Strict
**Problem:** Required 10 detections in 1.5s window (67% hit rate) - too hard with flickering detection
**Fix:** Lowered to 2 detections in 1.0s window (20% hit rate)
**Files:** `ros2_ws/src/r2d2_gesture/r2d2_gesture/gesture_intent_node.py`

---

## Current Status

### ‚úÖ Working
- VAD timeout stops sessions after 30s of silence
- Fist gesture detected continuously (visible in minimal_monitor)
- Fist gesture successfully stops speech sessions
- Two-stage fist logic triggers (Stage 1 ‚Üí Stage 2)

### ‚ùå Not Working Yet
- **Audio beeps not playing** (warning beep and stop beep)
- Beep triggers in code but no sound heard
- Need to debug audio playback system

---

## Parameters Changed

| Parameter | Old | New | Reason |
|-----------|-----|-----|--------|
| `vad_silence_timeout_seconds` | 60.0 | 30.0 | Better UX |
| `fist_window_seconds` | 1.5 | 1.0 | Easier to trigger |
| `fist_threshold` | 10 | 2 | Works with flickering detection |
| `gesture_frame_skip` | 2 | 1 | Detect every frame |

---

## Investigation Results: Audio Beeps

### Findings
- ‚úÖ Beeps ARE triggered in code (`‚ö†Ô∏è Playing warning beep`)
- ‚úÖ `_play_audio_feedback()` IS called
- ‚úÖ ffplay process starts (PID logged)
- ‚úÖ Beep files exist and are valid
- ‚úÖ Manual ffplay works perfectly
- ‚ùå **Subprocess ffplay becomes zombie** - no audio output

### Evidence
```bash
ps aux | grep ffplay
severin  51341  0.0  0.0  0  0 ?  Z  15:46  0:00 [ffplay] <defunct>
```

Logs show:
```
üîä Playing: Voicy_R2-D2 - 12.mp3, vol=0.105
‚úì ffplay PID: 51341
```

But PID 51341 is immediately defunct (zombie).

### Root Cause (Unresolved)
Subprocess environment issue when ffplay runs from ROS node context. Likely:
- Missing environment variables (DISPLAY, PULSE_SERVER)
- Audio device access permissions
- PulseAudio connection failure in subprocess context
- Different behavior vs audio_notification_node (which works!)

### Comparison
| Component | Method | Result |
|-----------|--------|--------|
| audio_notification_node | subprocess.Popen ffplay | ‚úÖ Works |
| gesture_intent_node | subprocess.Popen ffplay | ‚ùå Zombie |
| Manual ffplay | Direct command | ‚úÖ Works |

**Almost identical code** - mysterious why one works and other doesn't.

### Workaround
Core functionality works without beeps:
- Gestures detected reliably
- Sessions start/stop correctly  
- VAD timeout prevents billing issues
- Two-stage fist confirmation prevents accidents

Audio feedback would be nice but not critical for functionality.

---

## Files Modified

- `ros2_ws/src/r2d2_speech/r2d2_speech_ros/speech_node.py`
- `ros2_ws/src/r2d2_gesture/r2d2_gesture/gesture_intent_node.py`
- `ros2_ws/src/r2d2_gesture/launch/gesture_intent.launch.py`
- `ros2_ws/src/r2d2_perception/r2d2_perception/image_listener.py`
- `/etc/systemd/system/r2d2-camera-perception.service` (manual edit)

---

**Commit:** In-progress solution - fist gesture working, beeps pending
**Date:** 2026-01-02
**Status:** Working but incomplete (audio feedback issue remains)

